<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
</head>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<body>
    <div style="margin:0 auto; max-width:800px;">
        <div class="w3-sidebar w3-light-grey w3-bar-block" style="width:200px">
            <h3 class="w3-bar-item">Tools</h3>
            <a href="test-both.html" class="w3-bar-item w3-button">Test both BWA and Samtools</a>
            <a href="test-subread.html" class="w3-bar-item w3-button">Test subread</a>
        </div>

        <div style="margin-left:25%">
            <div class="w3-container w3-teal">
                <h3>Make BAM Files with bwa and samtools</h3>
            </div>
            <div style="margin-left:10%;max-width:400px;">
                <h4>I. Choose reference file (a fasta file)</h4>
                <input id="reference" type="file">

                <h4>II. Choose demultiplexed fastaq files</h4>
                <input id="fastq" type="file" multiple>

                <p id="demo1"></p>
                <p id="demoRef"></p>
                <p id="demoFq" style="display:none;"></p>
                <h4>III. Map reads and create bam files</h4>
                <p>After loading your template fasta file and all the fastq files, now we will use tool bwa and samtools to create indexed bam files for viewing in software IGV.</p>
                <button onclick="makeAll()">Step 1: Test align</button><br><br>
            </div>
        </div>
    </div>

<script src="./aioli/latest/aioli.js"></script>
<script>
document.getElementById("reference").addEventListener("change", loadRef, false);
document.getElementById("fastq").addEventListener("change", loadFq, false);

let align = new Aioli("subread-align/2.0.1");
let buildindex = new Aioli("subread-buildindex/2.0.1");
// Initialize
// buildindex will be Aioli.workers[0]
buildindex
.init()
.then(() => buildindex.exec(""))
.then(d => console.log(d.stdout, "ERRRRR", d.stderr));

// align will be Aioli.workers[1]
align
.init()
.then(() => align.exec("-v"))
.then(d => console.log(d.stdout, "ERRRRR", d.stderr));

// make all bams
async function makeAll(){
    await transferIndex();
    await delay(1000);
    let filenames = document.getElementById("demoFq").innerHTML.split("\t");
    for (i = 0; i < filenames.length; i++) {
        let ff = filenames[i];
        if (ff.includes("_R1_001.fastq.gz")) {
            console.log("Processing: ", ff);
            let prefix = ff.replace("_R1_001.fastq.gz", "");
            makeBam(prefix);
        }
    }
}

// make single bam
async function makeBam (prefix, index="my_index") {
    let wd = "/data/";
    align.setwd(wd);
    let R1 = prefix + "_R1_001.fastq.gz";
    let R2 = prefix + "_R2_001.fastq.gz"
    let out = prefix + ".bam";
    let cmd = ["-i", index, "-r", R1, "-R", R2, "-o", out, "-t 1 -I 15 --sv --sortReadsByCoordinates"].join(' ');
    console.log(cmd);
    let std = await align.exec(cmd);
    console.log(std.stderr);
    console.log("Finished writing ", out);
}

function loadFq(event)
{
    document.getElementById("demoFq").innerHTML = "";
    // var filenames = [];
    var files = event.target.files;
    for (var i = 0, f; f = files[i]; i++) {
        Aioli.mount(f, null, null, Aioli.workers[1]);// only to worker align
        document.getElementById("demoFq").innerHTML += f.name + "\t";
    }
    // bwa.ls("/bwa2/examples").then(d => console.log(d));
    // return(filenames);
}

async function loadRef(event)
{
    let files = event.target.files;
    let f = files[0];
    document.getElementById("demoRef").innerHTML = f.name;
    Aioli.mount(f, null, null, Aioli.workers[0]); // only to worker buildindex
    await delay(500);
    buildindex.ls("/data").then(console.log);
    // index
    buildindex.exec("-M 1000 -o /data/my_index /data/" + f.name)
    .then(d => console.log(d.stdout, "End of stdout\n", d.stderr, "End of stderr"))
}

// delay before
const delay = ms => new Promise(res => setTimeout(res, ms));
// transfer sam files to samtools /data
async function transferIndex(){
    let files = await buildindex.ls("/data"); // an array of files
    // let promises = [];
    for (var i = 0, f; f = files[i]; i++) {
        if (f.includes("my_index")) {
            // promises.push(Aioli.transfer("/data/" + f, "/data/" + f, Aioli.workers[0], Aioli.workers[1]));
            Aioli.transfer("/data/" + f, "/data/" + f, Aioli.workers[0], Aioli.workers[1]);
        }
    }
    // await Promise.all(promises);
    await delay(1000);
    console.log("Finished transfering files!");
    return 0;
}

</script>
<script src="libs/FileSaver.min.js"></script>
<script src="libs/jszip.min.js"></script>




</body>
</html>

