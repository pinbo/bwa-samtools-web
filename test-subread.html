<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
</head>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<body>
    <div style="margin:0 auto; max-width:800px;">
        <div class="w3-sidebar w3-light-grey w3-bar-block" style="width:200px">
            <h3 class="w3-bar-item">Tools</h3>
            <a href="test-both.html" class="w3-bar-item w3-button">Test both BWA and Samtools</a>
            <a href="test-subread.html" class="w3-bar-item w3-button">Test subread</a>
        </div>

        <div style="margin-left:25%">
            <div class="w3-container w3-teal">
                <h3>Make BAM Files with bwa and samtools</h3>
            </div>
            <div style="margin-left:10%;max-width:400px;">
                <h4>I. Choose reference file (a fasta file)</h4>
                <input id="reference" type="file">

                <h4>II. Choose demultiplexed fastaq files</h4>
                <input id="fastq" type="file" multiple>

                <p id="demo1"></p>
                <p id="demoRef"></p>
                <p id="demoFq" style="display:none;"></p>
                <h4>III. Map reads and create bam files</h4>
                <p>After loading your template fasta file and all the fastq files, now we will use tool bwa and samtools to create indexed bam files for viewing in software IGV.</p>
                <button onclick="makeBam()">Step 1: Test align</button><br><br>
            </div>
        </div>
    </div>

<script src="./aioli/latest/aioli.js"></script>
<script>
let align = new Aioli("subread-align/2.0.1");
let buildindex = new Aioli("subread-buildindex/2.0.1");
// Initialize
buildindex
.init()
.then(() => buildindex.exec(""))
.then(d => console.log(d.stdout, "ERRRRR", d.stderr));


align
.init()
.then(() => align.exec("-v"))
.then(d => console.log(d.stdout, "ERRRRR", d.stderr));

// buildindex will be Aioli.workers[0]
// align will be Aioli.workers[1]

// make sam file with bwa mem
// bwamem("2", "references.fa").then(d => console.log(d));
async function makeBam (prefix, reference) {
    await transferIndex();
    // let wd = "/bwa2/examples/";
    let wd = "/data/";
    align.setwd(wd);
    align.exec("-i my_index -r 72_R1_001.fastq.gz -R 72_R2_001.fastq.gz -o out72v3.bam -t 1 -I 10").then(d => console.log(d.stdout, "ERRRRR", d.stderr));
}

document.getElementById("reference").addEventListener("change", loadRef, false);
document.getElementById("fastq").addEventListener("change", loadFq, false);

function loadFq(event)
{
    document.getElementById("demoFq").innerHTML = "";
    // var filenames = [];
    var files = event.target.files;
    for (var i = 0, f; f = files[i]; i++) {
        Aioli.mount(f, null, null, Aioli.workers[1]);// only to worker align
        document.getElementById("demoFq").innerHTML += f.name + "\t";
    }
    // bwa.ls("/bwa2/examples").then(d => console.log(d));
    // return(filenames);
}


async function loadRef(event)
{
    let files = event.target.files;
    let f = files[0];
    document.getElementById("demoRef").innerHTML = f.name;
    Aioli.mount(f, null, null, Aioli.workers[0]); // only to worker buildindex
    await delay(500);
    buildindex.ls("/data").then(console.log);
    // index
    buildindex.exec("-M 1000 -o /data/my_index /data/" + f.name)
    .then(d => console.log(d.stdout, "End of stdout\n", d.stderr, "End of stderr"))
}

// delay before
const delay = ms => new Promise(res => setTimeout(res, ms));
// transfer sam files to samtools /data
async function transferIndex(){
    let files = await buildindex.ls("/data"); // an array of files
    // let promises = [];
    for (var i = 0, f; f = files[i]; i++) {
        if (f.includes("my_index")) {
            // promises.push(Aioli.transfer("/data/" + f, "/data/" + f, Aioli.workers[0], Aioli.workers[1]));
            Aioli.transfer("/data/" + f, "/data/" + f, Aioli.workers[0], Aioli.workers[1]);
        }
    }
    // await Promise.all(promises);
    await delay(1000);
    console.log("Finished transfering files!");
    return 0;
}

</script>
<script src="libs/FileSaver.min.js"></script>
<script src="libs/jszip.min.js"></script>




</body>
</html>

